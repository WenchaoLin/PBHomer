from datetime import *

def AsciiArt():
    print "                             ,..oooooooooob..                           "
    print "                       ,.dodOOOO\"\"\"\"\"\":\"ooPO88bo..                      "
    print "                     .o8O\"\"\" '            \"'\"\"\"PO8b.                    "
    print "                 .dd8P'\"                       ''::Y8o.                 "
    print "               ,d8Po'                             \"':7Ob;               "
    print "              d8P::'                                 ';:8b.             "
    print "            ;d8''\"                                     ';Y8;            "
    print "          ,d8O:'                                        ';:8b.          "
    print "         ,88o:'                                           ';Yb.         "
    print "        ,8P::'                                           . ';Yb         "
    print "       ,8o;:'                                          ,;'  ':8b        "
    print "      ,8:::'                                           ;:    :;8b       "
    print "     d8o;::                                            o:     ::8,      "
    print "    ,8':::                                            :::     :;Y8      "
    print "    8'oo:'                                            :::     :::8:     "
    print "   dP;:YO                                             ':::;.;;:::Y8.    "
    print "  ,8:::;Yb                                            :b::::::::::8b    "
    print "  dO;::::8b                                           'Yb::::::::::8.   "
    print " ,8;:::::O8,                                           'Y88::::::::8:   "
    print " 8P;::::::88                                             `8O::::::::O   "
    print " d::::::::88:                                             O8;:::::::8   "
    print " 8:::::::888:                                             88b:::::::O:  "
    print ",8::::::::88:                                            :888Oooo::;Y:  "
    print "dO:::::::bO8:             ..:.::::::::::...:             :888888P;::db  "
    print "OP:::::::O88:         ..o8888:::::::::::::)8888bo..       O8888O:::::8  "
    print "O;::::::::88'    ..od888888888::::\"\"\"\":::88888888888oo;   `8888;:::::8  "
    print "O:::ob:::;8:  ,d88888888888888::       ':88888888888888b;  '\"88;:::::8  "
    print "OO::;Yo::OP' d888888888888888O:'      ,.;8888888888888888b  ,88::::::8  "
    print "YO:::;Y::Ob ,8888888888888888;::       :;88888888888888888  :88::::::8  "
    print " 8;::::b;8' :8888888888888888o::        ':8888888888888888  :888d::)88  "
    print " Y:::::88P   888888888888888888'         'O888888888888888  :88888888P  "
    print " `b:::;8O    d888888888888888P'          ,8888888888888888  '88888888:  "
    print "  Y::::8:   ,88888888888888P:      ..    '8888888888888888   Y8888888:  "
    print "  8O::;8'   :88888888888888:      d88,   ':Y88888888888888   '8888888:  "
    print "  'YbooO    :8888888888P:8P:     :8888:    '':Y8888888888P    \"Y888YP   "
    print "   '888:     8888888P:;'8O:'     :8P88b       '\"O888888P\"       ;:;o'   "
    print "    `88:     \"oOOo:.::)O:;:      :8:888.        :8b'            :::'    "
    print "     88:      '\"\"\"\" ,do;:'      ,88bO88b     ,.o::PO:;.;.      :::'     "
    print "     88';           :' `Yb      d88O`888b    O8\"::::o::::::::::o:;      "
    print "     8O::b         ;:   ''     d88Po O888    :8;:\"\"\" '\";88::::o:::      "
    print "     YO:;Yb    :o.;::          O8P.: O888     'Y::    :YO8b:::::O'      "
    print "      Y:::8b  o;O:::;.         OO;:: OO;'       ''\"  .;bO88\"d:od'       "
    print "      `b::;8: :8bo::::;.       OO::: OK:          ,;:8888P',8OP\"        "
    print "       Yb:;OO  O888b::::;.     'O:O\",;\"'          ;o8888P  :O\"          "
    print "       '`Y888. :88888::::::     ':' db           ;o8888P   8P           "
    print "          '`8;  O8888::::::        '8'          :o8888P   :8'           "
    print "            OO: :8888::::::         Y:         ,::;888'   :8            "
    print "            `8,  o888\"::::'          '         ;:::88:    OP            "
    print "            ,8:   O888O8POYOOO\"OPOOPYO8OO8OO888888888'    O:            "
    print "            88:   '888o::o':Y: d  O  'Y:'8: O\"Y:`K:8o;    8'            "
    print "           88O;    ;88o;:::: : :  :   '  `:   '  ,:8 :   :8             "
    print "           O8O:.  ,:OP\"8bd;':: d...      ,.  .db.'\"8 ::  :O             "
    print "          ,88O::. ;:O: O\"'\"YP\"YPYP'YO\"\"\"`8K`O\"O `b:O.:;  :O             "
    print "          888o:::.:;Ob : :::: :::: :P ,  OO : :  O;:::: ;:O             "
    print "          888O::::::::`dbd::b.d::: :: db ::,d.8o;O;::::::dP             "
    print "           888::::::::;:\"\"\"\"\"Y8888od8d88o8P\"\"'\"  ':::::'d'              "
    print "           \"Y88Odo:\"::::         `\"\"\"\"'           ':::)P'               "
    print "             \"\"88888O:::                          ;::dP                 "
    print "                '\"\"88O:::                   oo;  ;O88'                  "
    print "                   `Y8O::.  ,.      .      '8b::O88'                    "
    print "                     Y8b::. ,)O   ,;'        ::O88'                     "
    print "                      '88d:..:   ,d:        ;'d88'                      "
    print "                       'Y88d::;.;:8b,   ,..:O88P'                       "
    print "                         \"\"88oodO888O::::bd88P'                         "
    print "                           '`8888888888888P\"'                           "
    print "                                 \"\"\"\"\"\"\"\"'                              "

    print "              *************************************"
    print "              *   ________.__.__                  *"                             
    print "              *  /  _____/|__|  |   ____   ______ *"
    print "              * /   \  ___|  |  | _/ __ \ /  ___/ *"
    print "              * \    \_\  \  |  |_\  ___/ \___ \  *"
    print "              *  \______  /__|____/\___  >____  > *"
    print "              *         \/             \/     \/  *"
    print "              *************************************"

def EnsureDirExists(p):
    d = os.path.dirname(p)
    if not os.path.exists(d):
	    os.makedirs(d)
 

def ReseedDB():
    DeleteInventoryData()
    DeleteRunData()
    DeleteSeedingData()
    SeedDB()

def DisableDiskSpaceMonitors():
    """Disable all drive space monitors on Blade0*"""
    from PacBio.Instrument.Diagnostics import *
    print 'Disabling Disk Space Monitors:'
    foo = MonitorSvc.GetInstance.All
    for bar in foo:
        s = bar.Device.ToString()
        print s, 
        if s.StartsWith('Blade0'):
	        bar.Enabled = False
        print bar.Enabled

def ClearDebugFilter():
    LogFilter.Instance.RemoveFilter(".*", ".*", "DEBUG", True)

def SetDebugFilter():
    LogFilter.Instance.AddFilter(".*", ".*", "DEBUG", True)

def MySchedulerProgressChanged(sender, args):
    print "."
    
def MySchedulingBegins(sender, args):
    print "."

def MySchedulingEnds(sender, args):
    print "."

def MyTaskStartEvent(task, args):
    print ".............................................."
    print ".............................................."
    print "Task: " + task.DisplayName + " Start"
    print ".............................................."
    print ".............................................."

def MyTaskFinishEvent(task, args):
    print ".............................................."
    print ".............................................."
    print "Task: " + task.DisplayName + " Finish"
    print ".............................................."
    print ".............................................."

def MyStepStartEvent(step, steparg):
    print ".............................................."
    print ".............................................."
    print "Step: " + steparg.Task.DisplayName + " Start (%s -> %s)" % (step.Source, step.Target)
    print ".............................................."
    print ".............................................."

def MyStepFinishEvent(step, steparg):
    print ".............................................."
    print ".............................................."
    print "Step: " + steparg.Task.DisplayName + " Finish (%s -> %s)" % (step.Source, step.Target)
    print ".............................................."
    print ".............................................."

def MyProjectScheduled(sender, args):
    job = instrument.RunController.CurrentPlateJob
    project = job.ProtocolContext.ScheduledProject
    name = job.MappedJob.Description
    print ". Project Scheduled (%s)." % name
    for entry in project.Schedule.Entries:
        entry.Task.TaskStartEvent += MyTaskStartEvent
        entry.Task.TaskFinishEvent += MyTaskFinishEvent
        for step in entry.Task.StepList:
	        step.StepStartEvent += MyStepStartEvent
	        step.StepFinishEvent += MyStepFinishEvent
	    
	path = "rendered_schedules/";
    EnsureDirExists(path)
    cwd = os.getcwd()
    os.chdir(path)    
    project.RenderSchedule("%s-schedule-%s.html" % (name, datetime.now().strftime("%Y-%m-%d-%H-%M-%S")))  
    os.chdir(cwd)

def MyRunStateChangedHandler(sender, args):
    state = instrument.RunController.CurrentRunState
    print ".............................................."
    print ".............................................."
    print "instrument.RunController.RunState: %s" % state
    print ".............................................."
    print ".............................................."
    
    if state == RunState.Running:
        job = instrument.RunController.CurrentPlateJob
        scheduler = instrument.RunController.CurrentPlateJob.Scheduler
        scheduler.SchedulingBegins += MySchedulingBegins
        scheduler.SchedulingEnds += MySchedulingEnds
        scheduler.ProgressChanged += MySchedulerProgressChanged
        job.ProjectScheduled += MyProjectScheduled	

AsciiArt()  
DisableDiskSpaceMonitors()   
instrument.FSM.SkipStabilization = True
instrument.RunController.RunStateChanged += MyRunStateChangedHandler
